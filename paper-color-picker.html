<!--

Material Design: Color picker inspired by <a href="http://www.google.com/design/spec/components/pickers.html">Material Design Pickers</a>

`paper-color-picker` is a color picker dialog that can be used to pick colors.

Example:

    <paper-color-picker id="picker"></paper-color-picker>

and to open the dialog

    this.$.picker.open();

@demo demo/index.html
-->
<link href="../polymer/polymer.html" rel="import">
<link href="../iron-flex-layout/iron-flex-layout.html" rel="import">
<link href="../paper-slider/paper-slider.html" rel="import">
<link href="../paper-dialog/paper-dialog.html" rel="import">
<link href="../paper-button/paper-button.html" rel="import">
<link href="../paper-input/paper-input.html" rel="import">
<link href="../paper-input/paper-input-container.html" rel="import">
<link href="../neon-animation/animations/fade-out-animation.html" rel="import">
<link href="../neon-animation/animations/scale-up-animation.html" rel="import">
<link href="color-names.html" rel="import">
<link href="paper-color-circle.html" rel="import">
<link href="rgb-input.html" rel="import">
<link href="hex-input.html" rel="import">

<dom-module id="paper-color-picker">
  <style>
    paper-color-circle {
      display: block;
      margin: auto;
      width: 200px;
      height: 200px;
    }

    :host /deep/ .color-picker-dialog::shadow #scroller {
      padding: 0;
    }

    #container {
      margin-top: 0;
      padding: 0;
    }

    paper-slider {
      width: 100%;
    }

    paper-input {
      width: 100%;
      padding: 0;
      box-sizing: border-box;
      margin: -1px 0 0 0;
    }

    #huePicker {
      width: 255px;
      margin: 15px;
      height: 15px;
      border-radius: 2px;
    }

    .landscapeOnly, .portraitOnly {
      display: none;
    }

    #dialog {
      display: flex;
      align-items: stretch;
    }

    #detail {
      min-width: 240px;
      margin: 0;
      padding: 0;
    }

    #title {
      position: absolute;
      text-align: left;
      color: white;
      @apply(--paper-font-common-base);
      font-size: 28px;
      font-weight: 400;
      letter-spacing: -.01em;
      line-height: 38px;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 20px;
      padding-bottom: 30px;
    }

    #preview {
      padding: 0;
      position: relative;
      margin-top: 0;
      background-image:
        linear-gradient(45deg, #eee 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #eee 75%),
        linear-gradient(45deg, #eee 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #eee 75%);
      background-size: 24px 24px;
      background-position: 0 0, 0 0, 12px 12px, 12px 12px;
    }

    .buttons {
      margin-top: 20px;
      padding-left: 0;
      padding-right: 0;
    }

    #rgb {
      display: flex;
    }

    #rgb paper-input {
      flex: 1;
      margin: 0 5px;
    }

    #rgb paper-input:first-child {
      margin-left: 0;
    }

    #rgb paper-input:last-child {
      margin-right: 0;
    }

    #color {
      position: absolute;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
    }

    @media only screen and (orientation : portrait) {
      .portraitOnly {
        display: block;
      }

      #preview {
        min-height: 91px;
      }

      #dialog {
        width: 90%;
        max-width: 350px;
        flex-direction: column;
      }

      #title{
        padding-top: 40px;
        padding-bottom: 15px;
      }

      #detail{
        padding-top: 20px;
      }

      #details {
        padding: 0 20px;
      }
    }

    @media only screen and (orientation : landscape) {
      :host {
        width: 480px;
      }

      #preview{
        width: 185px;
      }

      #detail {
        padding-top: 20px;
        padding-left: 20px;
        padding-right: 20px;
      }

      #container {
        display: flex;
        flex-direction: row;
      }

      .landscapeOnly {
        display: block;
      }
    }
  </style>

  <template>
    <color-names id="color-names"></color-names>

    <paper-dialog id="dialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      class="color-picker-dialog">

      <div id="preview">
        <div id="color"></div>
        <div id="title">
          <template is="dom-if" if="{{ showName }}">
            Color Picker
          </template>
          <template is="dom-if" if="{{ !showName }}">
            {{ _computeColorName(selectedColor) }}
          </template>
        </div>
      </div>

      <div id="detail">

        <paper-color-circle
          id="picker"
          shape="{{ shape }}"
          type="{{ type }}"
          value="{{ colorValue }}"
          color="{{ selectedColor }}"
          hue="{{ hue }}"
          lightness="{{ colorLightness }}"
          on-lightness-changed="_setSliders"
          on-value-changed="_setSliders">
        </paper-color-circle>

        <div id="details">

          <template is="dom-if" if="{{ _showBrightnessSlider(shape, type) }}">
            <paper-input-container attr-for-value="immediate-value">
              <label>Brightness</label>
              <paper-slider
                id="brightnessSlider"
                class="paper-input-input"
                min="0"
                max="100"
                pin="true"
                value="100"
                immediate-value="{{ brightness }}">
              </paper-slider>
            </paper-input-container>
          </template>

          <template is="dom-if" if="{{ _showLightnessSlider(shape, type) }}">
            <paper-input-container attr-for-value="immediate-value">
              <label>Lightness</label>
              <paper-slider
                id="lightnessSlider"
                class="paper-input-input"
                min="0"
                max="100"
                pin="true"
                value="50"
                immediate-value="{{ lightness }}">
              </paper-slider>
            </paper-input-container>
          </template>

          <template is="dom-if" if="{{ _showHuePicker(shape) }}">
            <paper-input-container attr-for-value="id">
              <label>Hue</label>
              <canvas
                id="huePicker"
                class="paper-input-input"
                on-tap="huePickerPickColor"
                on-track="huePickerPickColor"
                width="360"
                height="1">
              </canvas>
            </paper-input-container>
          </template>

          <template is="dom-if" if="{{ showAlpha }}">
            <paper-input-container
              attr-for-value="immediate-value"
              hidden$="{{ !advanced }}">
              <label>Alpha (Transparency)</label>
              <paper-slider
                id="alphaSlider"
                class="paper-input-input"
                min="0"
                max="1"
                step="0.01"
                value="{{ alpha }}"
                immediate-value="{{ alpha }}">
              </paper-slider>
            </paper-input-container>
          </template>

          <div hidden$="{{ !advanced }}">
            <div id="rgb">
              <rgb-input
                id="rgb-input"
                red="{{ red }}"
                green="{{ green }}"
                blue="{{ blue }}">
              </rgb-input>
            </div>
            <div id="hex">
              <hex-input id="hex-input" value$="{{ hex }}"></hex-input>
            </div>
          </div>
        </div>

        <div class="buttons">
          <paper-button on-tap="_toggleAdvancedMode" hidden$="{{ advanced }}">
            {{ _computeModeButtonText(advanced) }}
          </paper-button>
          <paper-button dialog-confirm on-tap="_setColor">
            OK
          </paper-button>
          <paper-button dialog-dismiss on-tap="_resetColor">
            Cancel
          </paper-button>
        </div>

      </div>
    </paper-dialog>
  </template>

  <script>
    Polymer({

      is: 'paper-color-picker',

      properties: {
        hue: {
          type: Number,
          value: 0,
          notify: true
        },

        colorLightness: {
          type: Number,
          value: 0.5
        },

        colorValue: {
          type: Number,
          value: 1
        },

        disableUpdate: {
          type: Boolean,
          value: false
        },

        alpha: {
          type: Number,
          value: 1,
          notify: true
        },

        showAlpha: {
          type: Boolean,
          value: false
        },

        red: {
          type: Number,
          value: 0,
          notify: true
        },

        green: {
          type: Number,
          value: 0,
          notify: true
        },

        blue: {
          type: Number,
          value: 0,
          notify: true
        },

        /**
          * *square*, *circle* or *huebox*
          *
          * @attribute shape
          * @type string
          * @default 'circle'
          */
        shape: {
          type: String,
          value: 'circle'
        },

        lightness: {
          type: Number,
          value: 50,
          observer: 'lightnessChanged',
          notify: true
        },

        brightness: {
          type: Number,
          value: 100,
          observer: 'brightnessChanged',
          notify: true
        },

        /**
          * *hsv* or *hsl*
          *
          * @attribute type
          * @type string
          * @default 'hsv'
          */
        type: {
          type: String,
          value: 'hsv'
        },

        name: {
          type: String,
          value: 'Black'
        },

        showName: {
          type: Boolean,
          value: false
        },

        advanced: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,
          observer: '_recenterDialog'
        },

        hex: {
          type: String,
          value: '000',
          notify: true
        }
      },

      listeners: {
        'iron-overlay-closed': '_resetColor'
      },

      observers: [
        'hexChanged(hex)'
      ],

      ready: function () {
        this._setHexFromRGB();

        window.addEventListener('resize', function () {
          this.$.dialog.resetFit();
        }.bind(this));
      },

      _computeModeButtonText: function (advanced) {
        return advanced ? 'Advanced' : 'Basic';
      },

      setColorWheel: function () {
        if (!this.disableUpdate) {
          if (this._showBrightnessSlider()) {
            this.set('colorValue', this.brightness / 100);
          }
          if (this._showLightnessSlider()) {
            this.colorLightness = this.lightness / 100;
          }

          setTimeout(function () {
            this.disableUpdate = false;
          }.bind(this), 50);
        }
        this.disableUpdate = true;
      },

      brightnessChanged: function () {
        this.setColorWheel();
      },

      lightnessChanged: function () {
        this.setColorWheel();
      },

      _calculateLuminance: function (r, g, b) {
        var a = [r,g,b].map(function (v) {
          v /= 255;
          return (v <= 0.03928) ?
            v / 12.92 :
            Math.pow( ((v+0.055)/1.055), 2.4 );
        });
        return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
      },

      colorChanged: function () {
        this._setHexFromRGB();
        this.$.color.style.backgroundColor = 'rgba(' + this.selectedColor['red'] + ',' + this.selectedColor['green'] + ',' + this.selectedColor['blue'] + ',' + this.selectedColor['alpha'] + ')';
      },

      hexChanged: function () {
        this._setRGBFromHex();
        this.$.color.style.backgroundColor = 'rgba(' + this.selectedColor['red'] + ',' + this.selectedColor['green'] + ',' + this.selectedColor['blue'] + ',' + this.selectedColor['alpha'] + ')';
      },

      drawHuePicker: function () {
        var context = Polymer.dom(this.root).querySelector('#huePicker').getContext('2d');
        var bitmap = context.getImageData(0, 0, 360, 30);

        for (var x = 0; x < 360; x++) {
          var hue = x;
          var color = this.$.picker.hsv2rgb(hue, 1, 1);
          bitmap.data[4 * x + 0] = color[0];
          bitmap.data[4 * x + 1] = color[1];
          bitmap.data[4 * x + 2] = color[2];
          bitmap.data[4 * x + 3] = 255;
        }

        context.putImageData(bitmap, 0, 0);
      },

      huePickerPickColor: function (e) {
        var rect = Polymer.dom(this.root).querySelector('#huePicker').getBoundingClientRect();
        var percentage = (e.detail.x - rect.left) / rect.width;
        if (percentage > 0 && percentage < 1)
          this.hue = percentage;
      },

      _setColor: function () {
        this.set('color', this.selectedColor);
        // this.set('color.red', this.selectedColor.red);
        // this.set('color.green', this.selectedColor.green);
        // this.set('color.blue', this.selectedColor.blue);
        // this.set('color.alpha', this.selectedColor.alpha);
        // this.set('color.name', this.selectedColor.name);
      },

      _resetColor: function () {
        this.set('selectedColor', this.color);
      },

      open: function () {
        this.$.dialog.open();
        if (this._showHuePicker())
          this.drawHuePicker();
      },

      _showBrightnessSlider: function () {
        return this.type == 'hsv' && this.shape !== 'huebox';
      },

      _showLightnessSlider: function () {
        return this.type == 'hsl' && this.shape !== 'huebox';
      },

      _showHuePicker: function () {
        return this.shape === 'huebox';
      },

      _toggleAdvancedMode: function () {
        this.advanced = !this.advanced;
      },

      _recenterDialog: function () {
        if (this.$.dialog.opened) this.$.dialog.center();
      },

      _setSliders: function () {
        this.async(function () {
          var brightnessSlider = Polymer.dom(this.root).querySelector('#brightnessSlider');
          if (brightnessSlider) {
            brightnessSlider.set('value', this.colorValue * 100);
          }

          var lightnessSlider = Polymer.dom(this.root).querySelector('#lightnessSlider');
          if (lightnessSlider) {
            lightnessSlider.set('value', this.colorLightness * 100);
          }
        });
      },

      _setHexFromRGB: function () {
        var rgb = this.blue | (this.green << 8) | (this.red << 16);
        var string = '#' + (0x1000000 + rgb).toString(16).slice(1);
        this.set('hex', string.toUpperCase());
      },

      _setRGBFromHex: function () {
        if (this.$['hex-input'].invalid) return;
        var matches = this.hex.match(/^#?([0-9a-f]{1,2})([0-9a-f]{1,2})([0-9a-f]{1,2})$/i);
        var colors = {};
        if (matches) {
          colors = matches.slice(1, 4).map(function (color) {
            return (color.length > 1 ? 1 : 0x11) * parseInt(color, 16);
          });
        }
        console.log(colors);
        this.set('red', colors[0]);
        this.set('green', colors[1]);
        this.set('blue', colors[2]);
      },

      _computeColorName: function (red, green, blue) {
        var closest = {
          color: undefined,
          distance: Infinity
        };

        this.$['color-names'].colorNames().forEach(function (color) {
          var distance = Math.sqrt(
            Math.pow(red - color.rgb[0], 2) +
            Math.pow(green - color.rgb[1], 2) +
            Math.pow(blue - color.rgb[2], 2)
          );
          if (distance < closest.distance) {
            closest.color = color;
            closest.distance = distance;
          }
        }.bind(this));

        this.name = closest.color.title;

        var luminance = Math.max(
          this._calculateLuminance.apply(this, closest.color.rgb),
          Math.min(1, 1 - this.alpha + 0.2)
        );
        var opacity = Math.max(0, luminance -.5) * 1.8;
        opacity = Math.round(opacity * 100) / 100;
        this.$.title.style.textShadow = 'rgba(0,0,0,' + opacity + ') 1px 0 60px';
      }
    });
  </script>
</dom-module>

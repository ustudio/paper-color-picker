<!doctype html>

<html>
<head>
  <meta charset="UTF-8">
  <title>paper-color-picker test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/test-helpers.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <link rel="import" href="../paper-color-picker.html">
</head>
<body>

  <test-fixture id="picker">
    <template>
      <paper-color-picker
        entry-animation="transform-automation"
        exit-animation="transform-automation"
        hex="#EF5323"
      ></paper-color-picker>
    </template>
  </test-fixture>

  <test-fixture id="hsl-picker">
    <template>
      <paper-color-picker
        entry-animation="transform-automation"
        exit-animation="transform-automation"
        type="hsl"
        hex="#EF5323"
      ></paper-color-picker>
    </template>
  </test-fixture>

  <script>
    function runAfterOpen (dialog, callback) {
      var listener = function() {
        dialog.removeEventListener('iron-overlay-opened', listener);
        callback.apply(null, arguments);
      };

      dialog.addEventListener('iron-overlay-opened', listener);
      dialog.open();
    }

   function sliderLeft(sliderBar) {
     var sliderRect = sliderBar.getBoundingClientRect();
     return {
       x: sliderRect.left + (sliderRect.width * 0.02),
       y: sliderRect.top + (sliderRect.height / 2)
     }
   }

    describe('paper-color-picker', function () {
      var element;
      var cancelSpy;
      var acceptSpy;
      var resetSpy;

      beforeEach(function () {
        element = fixture('picker');
        cancelSpy = sinon.spy();
        acceptSpy = sinon.spy(element, 'acceptChanges');
        resetSpy = sinon.spy(element, 'resetState');
        element.addEventListener('iron-overlay-canceled', cancelSpy);
      });

      it('should reset state when changes are canceled', function (done) {
        runAfterOpen(element, function () {
          MockInteractions.tap(
            Polymer.dom(element.root).querySelector('[dialog-dismiss]')
          );
          expect(cancelSpy).to.have.been.called;
          expect(resetSpy).to.have.been.called;
          expect(acceptSpy).to.not.have.been.called;
          done();
        });
      });

      it('should preserve state when changes are accepted', function (done) {
        runAfterOpen(element, function () {
          MockInteractions.tap(
            Polymer.dom(element.root).querySelector('[dialog-confirm]')
          );
          expect(cancelSpy).to.not.have.been.called;
          expect(resetSpy).to.not.have.been.called;
          expect(acceptSpy).to.have.been.called;
          done();
        });
      });

      it('should preserve color across edits', function(done) {
        element.hex = '#33E6E1';

        runAfterOpen(element, function() {
          MockInteractions.tap(
            Polymer.dom(element.root).querySelector('[dialog-confirm]')
          );

          Polymer.dom.flush();

          expect(element.hex).to.equal('#33E6E1');
          done();
        });
      });

      it('should update color when brightness slider is changed by user', function(done) {
        runAfterOpen(element, function() {
          var brightnessSlider = element.querySelector('#brightness-slider');
          var sliderBar = brightnessSlider.$.sliderBar
          var left = sliderLeft(sliderBar);

          MockInteractions.down(sliderBar, left);

          flush(function() {
            expect(element.brightness).to.equal(0.02);

            done();
          });
        });
      });

      it('should update color while user is dragging brightness slider', function(done) {
        runAfterOpen(element, function() {
          var brightnessSlider = element.querySelector('#brightness-slider');
          var sliderKnob = brightnessSlider.$.sliderKnob;

          var start = MockInteractions.middleOfNode(sliderKnob);
          var end = sliderLeft(brightnessSlider.$.sliderBar);

          MockInteractions.down(sliderKnob, start);
          MockInteractions.move(sliderKnob, start, end);

          flush(function() {
            expect(element.brightness).to.equal(0.02);

            done();
          });
        });
      });
    });

    describe('HSL mode paper-color-picker', function () {
      var element;

      beforeEach(function () {
        element = fixture('hsl-picker');
      });

      it('should preserve color across edits', function(done) {
        element.hex = '#005A00';

        runAfterOpen(element, function() {
          MockInteractions.tap(
            Polymer.dom(element.root).querySelector('[dialog-confirm]')
          );

          Polymer.dom.flush();

          expect(element.hex).to.equal('#005A00');
          done();
        });
      });

      it('should update color when luminosity slider is changed by user', function(done) {
        runAfterOpen(element, function() {
          var luminositySlider = element.querySelector('#luminosity-slider');
          var sliderBar = luminositySlider.$.sliderBar
          var left = sliderLeft(sliderBar);

          MockInteractions.down(sliderBar, left);

          flush(function() {
            expect(element.luminosity).to.equal(0.02);

            done();
          });
        });
      });

      it('should update color while user is dragging luminosity slider', function(done) {
        runAfterOpen(element, function() {
          var luminositySlider = element.querySelector('#luminosity-slider');
          var sliderKnob = luminositySlider.$.sliderKnob;

          var start = MockInteractions.middleOfNode(sliderKnob);
          var end = sliderLeft(luminositySlider.$.sliderBar);

          MockInteractions.down(sliderKnob, start);
          MockInteractions.move(sliderKnob, start, end);

          flush(function() {
            expect(element.luminosity).to.equal(0.02);

            done();
          });
        });
      });
    });
  </script>

</body>
</html>
